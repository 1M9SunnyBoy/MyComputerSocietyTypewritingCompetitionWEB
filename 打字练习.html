<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>打字比赛</title>

    <script>
        let bytes = new Array(232,174,161,231,174,151,230,156,186,230,152,175,228,184,128,231,167,141,231,148,168,228,186,142,228,191,161,230,129,175,229,164,132,231,144,134,231,154,132,231,148,181,229,173,144,232,174,190,229,164,135,227,128,130,229,174,131,229,143,175,228,187,165,232,191,155,232,161,140,229,144,132,231,167,141,229,164,141,230,157,130,231,154,132,232,174,161,231,174,151,239,188,140,229,173,152,229,130,168,229,164,167,233,135,143,228,191,161,230,129,175,239,188,140,229,185,182,229,143,175,233,128,154,232,191,135,232,190,147,229,133,165,232,190,147,229,135,186,232,174,190,229,164,135,228,184,142,231,148,168,230,136,183,232,191,155,232,161,140,228,186,164,228,186,146,227,128,130,232,174,161,231,174,151,230,156,186,231,154,132,229,143,145,229,177,149,231,187,143,229,142,134,228,186,134,229,164,154,228,184,170,233,152,182,230,174,181,239,188,140,228,187,142,230,156,128,229,136,157,231,154,132,229,183,168,229,158,139,230,156,186,229,136,176,231,142,176,229,156,168,231,154,132,229,176,143,229,158,139,229,140,150,227,128,129,230,153,174,229,143,138,229,140,150,229,146,140,230,153,186,232,131,189,229,140,150,227,128,130);
        let name;
        let id;
        let jsonString = "";
        let seed = "";
        let starttime = new Date();
        let loadtime;        
        let intervalId;

        starttime.setFullYear(2023);
        starttime.setMonth(11 -1);
        starttime.setDate(22);
        starttime.setHours(23);
        starttime.setMinutes(43);
        starttime.setSeconds(0);
        

        window.addEventListener('load', function(){
            loadtime = new Date();
            if(loadtime.getTime() - starttime.getTime() > 180000){
                clearInterval(intervalId);                 
                document.write('比赛超时！');
            }
            let inputElement = document.querySelector('#input');

            inputElement.addEventListener('paste', function(e) { 
                e.preventDefault();  
                alert("禁止粘贴");
            })  

            inputElement.addEventListener('input', function(event) {  
                let inputValue = event.target.value;

                let seedValue = Math.floor(Math.random()*10)

                jsonString += `{Value:[${inputValue}];Date:[${new Date().getTime()}];Seed:[${seedValue}]}`; 
                seed += seedValue;

                if(textcontrast(inputValue)){
                    inputElement.style.color = 'black';
                    if(inputValue.length == utf8ByteToUnicodeStr(bytes).length){
                        jsonString += `{End:[${new Date().getTime()}];Seed:${seed};Time:[${MygetTime('min')}:${MygetTime('sec')}:${MygetTime('mil')}]}`;
                        let jsonStr = JSON.stringify(jsonString);
                        let blob = new Blob([jsonStr], {type: "application/json"});  
                        let url = URL.createObjectURL(blob);  
                        let a = document.createElement("a");  
                        a.href = url;  
                        a.download = `${name}${id}.json`;
                        a.click();

                        document.write(`已完成！用时${MygetTime('min')}分${MygetTime('sec')}秒${MygetTime('mil')}毫秒`);
                    }
                }
                else{
                    inputElement.style.color = 'red';
                }
            });

            const timermin = document.querySelector('.timermin');
            const timersec = document.querySelector('.timersec');
            const timermil = document.querySelector('.timermil');
            intervalId = setInterval(function() {  
                timermin.innerText = (MygetTime('min'));
                timersec.innerText = (MygetTime('sec'));
                timermil.innerText = (MygetTime('mil'));

                let maxtime = 20;

                if(MygetTime('min') >= maxtime){
                        clearInterval(intervalId);
                        
                        jsonString += `{End:[${new Date().getTime()}];Seed:${seed};Timer:[null]}`;
                        let jsonStr = JSON.stringify(jsonString);
                        let blob = new Blob([jsonStr], {type: "application/json"});
                        let url = URL.createObjectURL(blob);
                        let a = document.createElement("a");
                        a.href = url;
                        a.download = `${name}${id}.json`;
                        a.click();

                        document.write(`比赛超时！用时${maxtime}分00秒00毫秒`);
                    }
            }, 10);  
        });

        function utf8ByteToUnicodeStr(utf8Bytes){
            let unicodeStr ="";
            for (let pos = 0; pos < utf8Bytes.length;){
                let flag= utf8Bytes[pos];
                let unicode = 0 ;
                if ((flag >>>7) === 0 ) {
                    unicodeStr+= String.fromCharCode(utf8Bytes[pos]);
                    pos += 1;

                } else if ((flag &0xFC) === 0xFC ){
                    unicode = (utf8Bytes[pos] & 0x3) << 30;
                    unicode |= (utf8Bytes[pos+1] & 0x3F) << 24;
                    unicode |= (utf8Bytes[pos+2] & 0x3F) << 18;
                    unicode |= (utf8Bytes[pos+3] & 0x3F) << 12;
                    unicode |= (utf8Bytes[pos+4] & 0x3F) << 6;
                    unicode |= (utf8Bytes[pos+5] & 0x3F);
                    unicodeStr+= String.fromCharCode(unicode) ;
                    pos += 6;

                }else if ((flag &0xF8) === 0xF8 ){
                    unicode = (utf8Bytes[pos] & 0x7) << 24;
                    unicode |= (utf8Bytes[pos+1] & 0x3F) << 18;
                    unicode |= (utf8Bytes[pos+2] & 0x3F) << 12;
                    unicode |= (utf8Bytes[pos+3] & 0x3F) << 6;
                    unicode |= (utf8Bytes[pos+4] & 0x3F);
                    unicodeStr+= String.fromCharCode(unicode) ;
                    pos += 5;

                } else if ((flag &0xF0) === 0xF0 ){
                    unicode = (utf8Bytes[pos] & 0xF) << 18;
                    unicode |= (utf8Bytes[pos+1] & 0x3F) << 12;
                    unicode |= (utf8Bytes[pos+2] & 0x3F) << 6;
                    unicode |= (utf8Bytes[pos+3] & 0x3F);
                    unicodeStr+= String.fromCharCode(unicode) ;
                    pos += 4;

                } else if ((flag &0xE0) === 0xE0 ){
                    unicode = (utf8Bytes[pos] & 0x1F) << 12;;
                    unicode |= (utf8Bytes[pos+1] & 0x3F) << 6;
                    unicode |= (utf8Bytes[pos+2] & 0x3F);
                    unicodeStr+= String.fromCharCode(unicode) ;
                    pos += 3;

                } else if ((flag &0xC0) === 0xC0 ){ //110
                    unicode = (utf8Bytes[pos] & 0x3F) << 6;
                    unicode |= (utf8Bytes[pos+1] & 0x3F);
                    unicodeStr+= String.fromCharCode(unicode) ;
                    pos += 2;

                } else{
                    unicodeStr+= String.fromCharCode(utf8Bytes[pos]);
                    pos += 1;
                }
            }
            return unicodeStr;
        }

        function textcontrast(text){
            let len = text.length;

            if(text == utf8ByteToUnicodeStr(bytes).substring(0, len)){
                return true;
            }
            else{
                return false;
            }
        }

        function MygetTime(what){
            let time = new Date().getTime() - starttime.getTime();
            if(time >= 0){
                document.querySelector('.timertext').innerText = '开始';
                document.querySelector('#input').style.display = 'block';
                document.querySelector('#rule').style.display = 'none';
                MygetTime = (what) => {
                    let time = new Date().getTime() - starttime.getTime();

                    switch(what){
                        case 'min':
                            let min = Math.trunc(time / 60000);                    
                            return min.toString().length == 1? '0' + min:min;
                        case 'sec':
                            let sec = Math.trunc(time % 60000 / 1000);
                            return sec.toString().length == 1? '0' + sec:sec;
                        case 'mil':
                            let mil = Math.trunc(time % 1000 / 10);
                            return mil.toString().length == 1? '0' + mil:mil;
                        default:
                            return null;
                    }
                }
            }
            time = Math.abs(time);

            switch(what){
                case 'min':
                    let min = Math.trunc(time / 60000);                    
                    return min.toString().length == 1? '0' + min:min;
                case 'sec':
                    let sec = Math.trunc(time % 60000 / 1000);
                    return sec.toString().length == 1? '0' + sec:sec;
                case 'mil':
                    let mil = Math.trunc(time % 1000 / 10);
                    return mil.toString().length == 1? '0' + mil:mil;
                default:
                    return null;
            }
        }
    </script>

    <style>
        body{
            margin: 0;
            padding: 0;

            font-size: 30px;

            background-color: #f1f1f1;

            font-family: 'Microsoft YaHei';
        }

        ::-webkit-scrollbar {  
            width: 10px;  
        }  
            
        ::-webkit-scrollbar-thumb {
            background: #c4c4c4;   
        }

        ::-webkit-scrollbar-track{
            background-color: #d3d3d3;

            border-radius: 0px 10px 10px 0px;

            overflow: hidden;
        }

        #textbox{
            position: absolute;
            top: 40px;
            right: 50%;
            bottom: 0;
            left: 0;

            /* border: 2px solid black; */

            user-select: none;  
            -ms-user-select: none;
            -moz-user-select: none;
            -webkit-user-select: none;
            -o-user-select: none;
        }

        #text{
            position: absolute;
            top: 10px;
            right: 5px;
            bottom: 10px;
            left: 10px;

            padding: 10px;

            border-radius: 10px;

            background-color: #e2e2e2;

            overflow-y: scroll;
        }

        #inputbox{
            position: absolute;
            top: 40px;
            right: 0;
            bottom: 0;
            left: 50%;
        }

        #input{
            display: none;

            position: absolute;

            top: 10px;
            right: 10px;
            bottom: 10px;
            left: 5px;

            padding: 10px;

            border: 0;
            border-radius: 10px;

            background-color: #e2e2e2;

            font-size: 30px;
            font-family: 'Microsoft YaHei';

            user-select: none;  
            -ms-user-select: none;
            -moz-user-select: none;
            -webkit-user-select: none;
            -o-user-select: none;

            resize: none;


        }
        .nav{
            width: auto;
            height: 30px;

            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;



            border-radius: 10px;

            background: #e2e2e2;

            font-size: 20px;
        }
        .nav div{
            height: 30px;
            line-height: 30px;
            padding: 0 10px;
        }
        .nav .timerbox{
            position: absolute;
            left: 50%;

            transform: translateX(-50%);

            border-radius: 10px;            

            background-color: #d3d3d3;
        }
        .nav .userbox{
            float: right;

            width: auto;
            height: 30px;
        }
    </style>
</head>
<body>
    <div class="nav">
        <div style="float: left;">
            请将左侧文章输入至右侧输入框内
        </div>
        <div class="timerbox">
            <span class="timertext">准备：</span><span class="timer"><span class="timermin">00</span>:<span class="timersec">00</span>:<span class="timermil">00</span></span>
        </div>
        <div class="userbox">
            <span>打字练习</span>
        </div>
    </div>
    <div id="textbox">
        <div id="text">
            <script>
                document.write(utf8ByteToUnicodeStr(bytes));
            </script>
        </div>
    </div>
    <div id="inputbox">
        <textarea type="textarea" id="input" name="input" placeholder="在此处输入文本"></textarea>
    </div>
</body>
</html>